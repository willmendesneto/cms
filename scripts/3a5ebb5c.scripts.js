"use strict";angular.module("config",[]).constant("ENV",{name:"production",repository:"movimento-sem-terra/site-novo/",basepath:"/cms"}),angular.module("cmsApp",["ngRoute","firebase","config","monospaced.elastic","ngTagsInput","ui.bootstrap"]).constant("IMAGE_SERVICE_URL","http://mst-image-service.herokuapp.com/upload").constant("FIREBASE_REF",new Firebase("https://mst-cms.firebaseio.com/customtags")).config(["$routeProvider","$httpProvider","$logProvider",function(a,b,c){b.defaults.useXDomain=!0,delete b.defaults.headers.common["X-Requested-With"],c.debugEnabled(!0),a.when("/auth",{templateUrl:"views/auth.html",controller:"AuthCtrl"}).when("/posts",{templateUrl:"views/posts.html",controller:"PostsCtrl"}).when("/post/:fileName",{templateUrl:"views/post.html",controller:"PostCtrl"}).when("/post",{templateUrl:"views/post.html",controller:"PostCtrl"}).otherwise({redirectTo:"/auth"})}]).run(["$rootScope","$location",function(a,b){a.$on("$locationChangeStart",function(){return a.error=null,a.github?void 0:(b.path("/auth").replace(),!1)})}]),angular.module("cmsApp").controller("PostCtrl",["$scope","$rootScope","$routeParams","Post","_","DateUtil","$timeout","GitRepository","$modal",function(a,b,c,d,e,f,g,h,i){function j(){return d.makePost()}function k(a,b){for(var c=a.length,d=0;c>d;d++)if(a[d].value===b)return a[d]}function l(a){if(a.name)return a.name;var b,c="",d=f.getTime(),e=("0"+(d.getMonth()+1)).slice(-2);return c=d.getFullYear()+"-"+e+"-"+d.getDate(),b=a.content.meta.title.toLowerCase().replace(/[^\w\s]/gi,"").replace(/[ ]([a-zA-Z])/g,function(a,b){return"-"+b}),c+"-"+b+".md"}function m(b){a.post=d.makePost(b),a.post.loadContentFromJekyllData(atob(b.content)),g(function(){a.menuTag=a.post.getMenuItem(),a.section=k(a.sectionOptions,a.post.getSection()),a.label=k(a.labelOptions,a.post.getLabel()),a.imagesHD=a.post.getImagesHD()},0)}a.menuTagOptions=["agricultura camponesa","agronegócio","direitos humanos","educação, cultura e comunicação","lutas e mobilizações","solidariedade internacional","meio ambiente","projeto popular","reforma agrária","transgênicos"],a.sectionOptions=[{label:"Destaque",value:"featured-news"},{label:"Debate",value:"debate"},{label:"Capa",value:"cover"},{label:"MST TV",value:"tv"}],a.labelOptions=[{label:"Artigo",value:"articles"},{label:"Entrevista",value:"interviews"},{label:"Reportagens Especiais",value:"special-stories"}],a.$watch("label",function(b){a.post.setLabel(b)}),a.$watch("menuTag",function(b){a.post.setMenuItem(b)}),a.$watch("section",function(b){a.post.setSection(b)}),a.$watch("imagesHD",function(b){a.post.setImagesHD(b)});var n=c.fileName;a.post=j(),n?h.getPost(n).done(function(a){m(a)}):a.post.create(),a.save=function(a,b){i.open({templateUrl:"saveModalContent.html",controller:"SaveModalCtrl",backdrop:"static",resolve:{url:function(){return b},post:function(){return a},fileName:function(){return c.fileName},loadPost:function(){return m}}})},a.publish=function(b){var c=h.getPublishedRepositoryAddress(a.prepareNameFile(b));a.save(b,c)},a.draft=function(b){var c=h.getDraftsRepositoryAddress(a.prepareNameFile(b));a.save(b,c)},a.prepareNameFile=function(a){return l(a)},a.postStatus=function(){var b=new RegExp("^https?://.*?/_drafts/?"),c=new RegExp("^https?://.*?/_posts/?");return"undefined"==typeof a.post.html_url?"NOVO":b.exec(a.post.html_url)?"RASCUNHO":c.exec(a.post.html_url)?"PUBLICADO":""}}]),angular.module("cmsApp").controller("UploadCtrl",["$scope","Image",function(a,b){function c(a){return{image:a,thumbnail:a,description:a}}a.uploadImage=function(){var d=a.file,e=-1;if(d){var f=d;e=a.images.push(c("images/loading.gif"))-1,b.send(f,e,a.addImage)}return e},a.images=[],a.currentImage=a.images[0],a.setCurrentImage=function(b){a.currentImage=b,window.alert("Utilize CTRL+C/CMD+C para copiar o endereço da imagem.")},a.addImage=function(b,d){a.images[b]=c(d)}}]),angular.module("cmsApp").controller("SaveModalCtrl",["$rootScope","$scope","$timeout","$modalInstance","GitRepository","url","post","fileName","loadPost",function(a,b,c,d,e,f,g,h,i){function j(a,d,e,f){c(function(){b.dynamic=a,b.type=d,b.status=e,b.finish=f},0)}b.max=5,b.problem=!1,b.isCollapse=!1,b.finish=!1,j(1,"info","Preparando dados");var k=JSON.stringify(g.commitData());a.github.put(f,{data:k,cache:!1,statusCode:{409:function(){var a="Ei, uma outra pessoa já fez alteração nesse texto.\n\nO melhor a se fazer agora é salvar o seus dados em sua maquina e tenta novamente\n\nDesculpas pelo transtorno :/";c(function(){b.problem=!0,b.detail=a},0)}}}).progress(function(){j(2,"warning","Enviando os dados")}).success(function(){j(4,"info","Carregando dados do servidor"),e.getPost(h).done(function(a){i(a),j(5,"success","Salvo com sucesso",!0)})}).error(function(a){j(5,"danger","Ops, um problema aconteceu!",!0),c(function(){b.error=a},0)}),b.ok=function(){d.close()}}]),angular.module("cmsApp").controller("PostsCtrl",["$scope","$rootScope","_","Post","$filter","GitRepository","$timeout",function(a,b,c,d,e,f,g){f.getDrafts().success(function(b){g(function(){a.posts=c.map(b,d.makePost),a.currentPage=0,a.pageSize=10,a.numberOfPages=function(){return Math.ceil(a.posts.length/a.pageSize)},a.nextPage=function(){a.currentPage=a.currentPage+1},a.previousPage=function(){a.currentPage=a.currentPage-1}},0)})}]),angular.module("cmsApp").controller("AuthCtrl",["$scope","$rootScope","$location","oauth",function(a,b,c,d){a.authenticate=function(){d.popup("github",function(d,e){return d?alert(d):(b.github=e,c.path("/posts"),void a.$apply())})}}]),angular.module("cmsApp").factory("oauth",function(){var a=window.OAuth;return a.initialize("S2shWzj2Cp87Mg4estazc6DFGQc"),a}),angular.module("cmsApp").directive("ckEditor",["ENV",function(a){return{require:"?ngModel",link:function(b,c,d,e){var f=window.CKEDITOR.replace(c[0]);CKEDITOR.plugins.addExternal("youtube",a.basepath+"/ckeditor-plugins/youtube/","plugin.js"),f.config.extraPlugins="youtube",f.config.height="100%",f.config.language="pt-BR",e&&(f.on("pasteState",function(){b.$apply(function(){e.$setViewValue(f.getData())})}),e.$render=function(){f.setData(e.$viewValue)})}}}]),angular.module("cmsApp").directive("upload",function(){return{restrict:"A",controller:"UploadCtrl",scope:{file:"="},link:function(a,b){b.bind("change",function(b){var c=b.target.files;a.file=c[0],a.$apply()})}}}),angular.module("cmsApp").directive("selectOnFocus",function(){return{restrict:"A",link:function(a,b){b.on("focus",function(){this.select()})}}}),angular.module("cmsApp").factory("_",function(){return window._}),angular.module("cmsApp").factory("Image",["$http","$rootScope","IMAGE_SERVICE_URL","FormDataObject",function(a,b,c,d){var e={send:function(e,f,g){a({url:c,method:"POST",transformRequest:d,headers:{"Content-Type":void 0},data:{token:b.github.access_token,myfile:e}}).success(function(a){g(f,a)}).error(function(a,b,c){console.log("error"),console.log(a),console.log(b),console.log(c)})}};return e}]),angular.module("cmsApp").factory("FormDataObject",function(){return function(a){var b=new FormData;return angular.forEach(a,function(a,c){b.append(c,a)}),b}}),angular.module("cmsApp").factory("CustomTag",["$firebase","FIREBASE_REF",function(a,b){var c=a(b),d={all:c,addNewCustomTag:function(a){c.$add(a)}};return d}]),angular.module("cmsApp").service("Post",["_","jsyaml","CustomTag","DateUtil",function(a,b,c,d){return{makePost:function(c){var e={};return a.extend(e,c),e.loadContentFromJekyllData=function(a){var c=decodeURIComponent(escape(a)).split("---");e.content={text:c.pop().replace(/^\n/,""),meta:b.load(c.pop())},e.loadTags()},e.create=function(){e.content={text:"",meta:{layout:"post",title:"",legacy_url:"",created:0,images:"",video:"",tags:[],type:"",support_line:"",section:"",hat:"",label:"",images_hd:""}}},e.getContent=function(){return e.content.meta.created||(e.content.meta.created=d.getTime().getTime()),e.content.meta},e.convertContentToJekyllData=function(){if(!e.content)return"";var a=["---",b.dump(e.getContent()),"---",e.content.text].join("\n");return unescape(encodeURIComponent(a))},e.commitData=function(){return e.prepareTags(),{sha:e.sha,content:btoa(e.convertContentToJekyllData()),message:"commit from cms"}},e.setMenuItem=function(b){e.content&&(e.content.meta.tags=a.filter(e.content.meta.tags,function(a){return!/^menu:/.test(a)}),b&&e.content.meta.tags.push("menu:"+b))},e.getMenuItem=function(){if(!e.content)return"";var b=a.filter(e.content.meta.tags,function(a){return/^menu:/.test(a)});return 0===b.length?"":b[0].substr(5)},e.setLabel=function(a){return e.content?a?void(e.content.meta.label=a.value):void(e.content.meta.label=""):void 0},e.getLabel=function(){return e.content?e.content.meta.label:""},e.setSection=function(a){return e.content?a?void(e.content.meta.section=a.value):void(e.content.meta.section=""):void 0},e.getSection=function(){return e.content?e.content.meta.section:""},e.setImagesHD=function(a){return e.content?a?void(e.content.meta.images_hd=a):void(e.content.meta.images_hd=""):void 0},e.getImagesHD=function(){return e.content?e.content.meta.images_hd:""},e.tags=[],e.loadTags=function(){if(e.content.meta.tags){var b=a.filter(e.content.meta.tags,function(a){return/^tag:/.test(a)});e.tags=[],a.each(b,function(a){var b=a.match(/tag:(.*)/)[1];e.tags.push({text:b})})}},e.prepareTags=function(){if(e.content.meta.tags){var b=a.filter(e.content.meta.tags,function(a){return!/^tag:/.test(a)});e.content.meta.tags=[],e.content.meta.tags.push(b),a.each(e.tags,function(a){e.content.meta.tags.push("tag:"+a.text)})}},e}}}]),angular.module("cmsApp").factory("GitRepository",["$rootScope","$location","ENV",function(a,b,c){function d(b){return a.github.get(e(b))}function e(a){return"/repos/"+c.repository+a}var f={getDrafts:function(){return a.github?d("contents/_drafts"):void console.log("Github not defined.")},getPost:function(b){return a.github?d("contents/_drafts/"+b):void console.log("Github not defined.")},getDraftsRepositoryAddress:function(a){return e("contents/_drafts/"+a)},getPublishedRepositoryAddress:function(a){return e("contents/_posts/"+a)}};return f}]),angular.module("cmsApp").factory("DateUtil",function(){return{getTime:function(){return new Date}}}),angular.module("cmsApp").factory("jsyaml",function(){return window.jsyaml}),angular.module("cmsApp").filter("startFrom",function(){return function(a,b){return b=+b,"object"==typeof a&&a.length>0?a.slice(b):[]}});