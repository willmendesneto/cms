"use strict";var app=angular.module("cmsApp",["ngRoute","firebase"]);app.constant("FIREBASE_URL","https://mst-cms.firebaseio.com"),app.constant("IMAGE_SERVICE_URL","http://mst-image-service.herokuapp.com/upload"),app.config(["$routeProvider",function(a){a.when("/auth",{templateUrl:"views/auth.html",controller:"AuthCtrl"}).when("/posts",{templateUrl:"views/posts.html",controller:"PostsCtrl"}).when("/posts/:sha",{templateUrl:"views/post.html",controller:"PostCtrl"}).otherwise({redirectTo:"/auth"})}]),app.config(["$httpProvider",function(a){a.defaults.useXDomain=!0,delete a.defaults.headers.common["X-Requested-With"]}]),app.controller("PostCtrl",["$scope","$rootScope","$routeParams","Image",function(a,b,c,d){function e(a){return b.posts.filter(function(b){return b.sha===a}).shift(0)}function f(a){return"https://api.github.com/repos/movimento-sem-terra/site-novo/git/blobs/"+a}function g(a){return"/repos/movimento-sem-terra/site-novo/contents/_drafts/"+a}var h=c.sha;a.post=e(h),a.menuTagOptions=["agricultura camponesa","agronegócio","direitos humanos","educação, cultura e comunicação","lutas e mobilizações","solidariedade internacional","meio ambiente","projeto popular","reforma agrária","transgênicos"],a.sectionOptions=[{label:"Destaque",value:"featured-news"},{label:"Debate",value:"debate"},{label:"Capa",value:"cover"},{label:"MST TV",value:"tv"}],a.labelOptions=[{label:"Artigo",value:"articles"},{label:"Entrevista",value:"interviews"},{label:"Reportagens Especiais",value:"special-stories"}],a.menuTag=void 0,a.section=void 0,a.label=void 0,a.tag="",a.imagesHD=void 0,a.$watch("label",function(b){a.post.setLabel(b)}),a.$watch("menuTag",function(b){a.post.setMenuItem(b)}),a.$watch("section",function(b){a.post.setSection(b)}),b.github.get(f(h)).done(function(b){a.post.loadContentFromJekyllData(atob(b.content)),a.$apply()}),a.save=function(a){b.github.put(g(a.name),{data:JSON.stringify(a.commitData())}).done(function(){alert("Post salvo com sucesso!")}).fail(function(a){console.log("error data:",a)})},a.uploadImage=function(){var a=document.getElementById("imgFile");if(a.files.length>0){var b=a.files[0];d.send(b),window.alert(d)}},a.images=[{image:"https://farm4.staticflickr.com/3911/14389454462_6e748234db_b.jpg",thumbnail:"https://farm4.staticflickr.com/3911/14389454462_6e748234db_b.jpg",description:"Test 1"},{image:"https://farm4.staticflickr.com/3836/14168485908_5527ba07fc_b.jpg",thumbnail:"https://farm4.staticflickr.com/3836/14168485908_5527ba07fc_b.jpg",description:"Test 2"},{image:"https://farm4.staticflickr.com/3911/14389454462_6e748234db_b.jpg",thumbnail:"https://farm4.staticflickr.com/3911/14389454462_6e748234db_b.jpg",description:"Test 3"}],a.currentImage=a.images[0],a.setCurrentImage=function(b){a.currentImage=b}}]),app.controller("PostsCtrl",["$scope","$rootScope","_","Post",function(a,b,c,d){b.github.get("/repos/movimento-sem-terra/site-novo/contents/_drafts").done(function(e){b.posts=c.map(e,d.makePost),a.$apply()})}]),app.controller("AuthCtrl",["$scope","$rootScope","$location","oauth",function(a,b,c,d){a.authenticate=function(){d.popup("github",function(d,e){return d?alert(d):(b.github=e,c.path("/posts"),void a.$apply())})}}]),app.factory("oauth",function(){var a=window.OAuth;return a.initialize("S2shWzj2Cp87Mg4estazc6DFGQc"),a}),app.directive("ckEditor",function(){return{require:"?ngModel",link:function(a,b,c,d){var e=window.CKEDITOR.replace(b[0]);e.on("instanceReady",function(){e.setData(d.$viewValue)}),e.on("pasteState",function(){a.$apply(function(){d.$setViewValue(e.getData())})}),d.$render=function(){e.setData(d.$modelValue)}}}}),app.factory("_",function(){return window._}),app.factory("Image",["$http","$rootScope","IMAGE_SERVICE_URL","FormDataObject",function(a,b,c,d){var e={send:function(e){var f="";a({url:c,method:"POST",transformRequest:d,headers:{"Content-Type":void 0},data:{token:b.github.access_token,myfile:e}}).success(function(a,b,c,d){console.log("success"),console.log(a),console.log(b),console.log(c),console.log(d),f=a}).error(function(a,b,c,d){console.log("error"),console.log(a),console.log(b),console.log(c),console.log(d),f=a})}};return e}]),app.factory("FormDataObject",function(){return function(a){var b=new FormData;return angular.forEach(a,function(a,c){b.append(c,a)}),b}}),app.service("Post",["_","jsyaml",function(a,b){return{makePost:function(c){var d={};return a.extend(d,c),d.loadContentFromJekyllData=function(a){var c=decodeURIComponent(escape(a)).split("---");d.content={text:c.pop().replace(/^\n/,""),meta:b.load(c.pop())}},d.convertContentToJekyllData=function(){if(!d.content)return"";var a=["---",b.dump(d.content.meta),"---",d.content.text].join("\n");return unescape(encodeURIComponent(a))},d.commitData=function(){return{sha:d.sha,content:btoa(d.convertContentToJekyllData()),message:"commit from cms"}},d.setMenuItem=function(b){d.content&&(d.content.meta.tags=a.filter(d.content.meta.tags,function(a){return!/^menu:/.test(a)}),b&&d.content.meta.tags.push("menu:"+b))},d.setLabel=function(a){return d.content?a?void(d.content.meta.label=a.value):void(d.content.meta.label=""):void 0},d.setSection=function(a){return d.content?a?void(d.content.meta.section=a.value):void(d.content.meta.section=""):void 0},d.setImagesHD=function(a){return d.content?a?void(d.content.meta.images_hd=a):void(d.content.meta.images_hd=""):void 0},d.addNewTag=function(a){d.content.meta.tags&&(a="personalizada:"+a,d.content.meta.tags.push(a))},d}}}]),app.factory("jsyaml",function(){return window.jsyaml});